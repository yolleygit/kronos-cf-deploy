name: Publish forecasts to R2

on:
  schedule:
    - cron: "5 * * * *"   # æ¯å°æ—¶05åˆ†è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'configs/**'
      - 'core/**'
      - 'model/**'
      - '.github/workflows/publish-to-r2.yml'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_PUBLIC_BASE: ${{ secrets.R2_PUBLIC_BASE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-glx libglib2.0-0

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r configs/requirements.txt
          pip install boto3

      - name: Create necessary directories
        run: |
          mkdir -p data
          mkdir -p records
          mkdir -p predictions_raw/latest
          mkdir -p web/public/data
          mkdir -p web/public

      - name: Run BTC forecast (ccxt)
        run: |
          echo "ðŸš€ å¼€å§‹è¿è¡Œ BTC é¢„æµ‹ (ccxt)..."
          KRONOS_CONFIG=configs/config.btc.yaml python run_single.py --config configs/config.btc.yaml
          echo "âœ… BTC é¢„æµ‹å®Œæˆ"

      - name: Run ETH forecast (ccxt)
        run: |
          echo "ðŸš€ å¼€å§‹è¿è¡Œ ETH é¢„æµ‹ (ccxt)..."
          KRONOS_CONFIG=configs/config.eth.yaml python run_single.py --config configs/config.eth.yaml
          echo "âœ… ETH é¢„æµ‹å®Œæˆ"

      - name: Prepare upload files
        run: |
          echo "ðŸ“¦ å‡†å¤‡ä¸Šä¼ æ–‡ä»¶..."
          
          # åˆ›å»ºä¸Šä¼ ç›®å½•ç»“æž„
          mkdir -p upload/predictions_raw
          mkdir -p upload/records
          mkdir -p upload/public/data
          mkdir -p upload/public
          
          # å¤åˆ¶é¢„æµ‹æ•°æ®
          if [ -d "predictions_raw/latest" ]; then
            cp -r predictions_raw/latest/* upload/predictions_raw/
            echo "âœ… å¤åˆ¶é¢„æµ‹æ•°æ®å®Œæˆ"
          else
            echo "âš ï¸ predictions_raw/latest ç›®å½•ä¸å­˜åœ¨"
          fi
          
          # å¤åˆ¶è®°å½•æ–‡ä»¶
          if [ -f "records/latest_btc.json" ]; then
            cp records/latest_btc.json upload/records/
            echo "âœ… å¤åˆ¶ BTC è®°å½•æ–‡ä»¶å®Œæˆ"
          else
            echo "âš ï¸ records/latest_btc.json ä¸å­˜åœ¨"
          fi
          
          if [ -f "records/latest_eth.json" ]; then
            cp records/latest_eth.json upload/records/
            echo "âœ… å¤åˆ¶ ETH è®°å½•æ–‡ä»¶å®Œæˆ"
          else
            echo "âš ï¸ records/latest_eth.json ä¸å­˜åœ¨"
          fi
          
          # å¤åˆ¶å‰ç«¯æ•°æ®æ–‡ä»¶
          if [ -f "web/public/data/dashboard.json" ]; then
            cp web/public/data/dashboard.json upload/public/data/
            echo "âœ… å¤åˆ¶ dashboard.json å®Œæˆ"
          else
            echo "âš ï¸ web/public/data/dashboard.json ä¸å­˜åœ¨"
          fi
          
          if [ -f "web/public/data/eth_dashboard.json" ]; then
            cp web/public/data/eth_dashboard.json upload/public/data/
            echo "âœ… å¤åˆ¶ eth_dashboard.json å®Œæˆ"
          else
            echo "âš ï¸ web/public/data/eth_dashboard.json ä¸å­˜åœ¨"
          fi
          
          # å¤åˆ¶å›¾è¡¨æ–‡ä»¶
          if [ -f "web/public/prediction_chart.png" ]; then
            cp web/public/prediction_chart.png upload/public/
            echo "âœ… å¤åˆ¶ BTC å›¾è¡¨å®Œæˆ"
          else
            echo "âš ï¸ web/public/prediction_chart.png ä¸å­˜åœ¨"
          fi
          
          if [ -f "web/public/eth_prediction_chart.png" ]; then
            cp web/public/eth_prediction_chart.png upload/public/
            echo "âœ… å¤åˆ¶ ETH å›¾è¡¨å®Œæˆ"
          else
            echo "âš ï¸ web/public/eth_prediction_chart.png ä¸å­˜åœ¨"
          fi
          
          # åˆ—å‡ºä¸Šä¼ æ–‡ä»¶
          echo "ðŸ“‹ å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          find upload -type f -exec echo "  {}" \;

      - name: Configure AWS CLI for R2
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: auto
          # è‡ªå®šä¹‰ S3 ç«¯ç‚¹ï¼ˆR2ï¼‰
          audience: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          role-to-assume: ""

      - name: Upload to R2
        run: |
          echo "â˜ï¸ å¼€å§‹ä¸Šä¼ åˆ° Cloudflare R2..."
          
          # è®¾ç½® R2 ç«¯ç‚¹
          R2_ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ° R2
          aws s3 cp upload/ s3://${R2_BUCKET}/ \
            --endpoint-url ${R2_ENDPOINT} \
            --recursive \
            --acl public-read \
            --cache-control "max-age=3600"
          
          echo "âœ… ä¸Šä¼ å®Œæˆï¼"
          echo "ðŸŒ è®¿é—®åœ°å€: ${R2_PUBLIC_BASE}"

      - name: Verify upload
        run: |
          echo "ðŸ” éªŒè¯ä¸Šä¼ ç»“æžœ..."
          R2_ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          
          # åˆ—å‡º R2 ä¸­çš„æ–‡ä»¶
          aws s3 ls s3://${R2_BUCKET}/ \
            --endpoint-url ${R2_ENDPOINT} \
            --recursive

      - name: Create deployment summary
        run: |
          echo "ðŸ“Š éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- é¢„æµ‹æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- BTC é¢„æµ‹ (ccxt): âœ… å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ETH é¢„æµ‹ (ccxt): âœ… å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- R2 ä¸Šä¼ : âœ… å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- è®¿é—®åœ°å€: ${R2_PUBLIC_BASE}" >> $GITHUB_STEP_SUMMARY
